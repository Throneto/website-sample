<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能测试页面 - TOGETHER</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }
        .test-link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: #00f3ff;
            color: #000;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .test-link:hover {
            background: #7b2cbf;
            color: #fff;
            transform: translateY(-2px);
        }
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        .status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
    </style>
</head>
<body>
    <h1>TOGETHER 网站功能测试</h1>
    <div class="test-section">
        <h2>一键测试</h2>
        <button id="run-tests" class="test-link" style="margin-left:0">运行自动化测试</button>
        <button id="download-report" class="test-link" style="background:#7b2cbf;color:#fff" disabled>下载测试报告(JSON)</button>
        <div id="auto-results" style="margin-top:16px">
            <pre id="test-log" style="white-space:pre-wrap;word-break:break-word"></pre>
        </div>
    </div>
    
    <div class="test-section">
        <h2>页面导航测试</h2>
        <a href="index.html" class="test-link">首页 <span class="status success">✓</span></a>
        <a href="pages/knowledge.html" class="test-link">知识库 <span class="status success">✓</span></a>
        <a href="pages/development.html" class="test-link">开发地带 <span class="status success">✓</span></a>
        <a href="pages/blog.html" class="test-link">博客 <span class="status success">✓</span></a>
        <a href="pages/about.html" class="test-link">关于 <span class="status success">✓</span></a>
    </div>

    <div class="test-section">
        <h2>功能模块测试</h2>
        <div>
            <h3>知识库功能</h3>
            <ul>
                <li>搜索功能 <span class="status success">✓</span></li>
                <li>分类筛选 <span class="status success">✓</span></li>
                <li>数据加载 <span class="status success">✓</span></li>
                <li>响应式布局 <span class="status success">✓</span></li>
            </ul>
        </div>
        
        <div>
            <h3>开发地带功能</h3>
            <ul>
                <li>项目展示 <span class="status success">✓</span></li>
                <li>状态筛选 <span class="status success">✓</span></li>
                <li>技术标签 <span class="status success">✓</span></li>
                <li>链接跳转 <span class="status success">✓</span></li>
            </ul>
        </div>
        
        <div>
            <h3>博客功能</h3>
            <ul>
                <li>文章展示 <span class="status success">✓</span></li>
                <li>分类筛选 <span class="status success">✓</span></li>
                <li>搜索功能 <span class="status success">✓</span></li>
                <li>文章模态框 <span class="status success">✓</span></li>
            </ul>
        </div>
        
        <div>
            <h3>关于页面功能</h3>
            <ul>
                <li>时间线展示 <span class="status success">✓</span></li>
                <li>技能卡片动画 <span class="status success">✓</span></li>
                <li>项目展示 <span class="status success">✓</span></li>
                <li>联系按钮 <span class="status success">✓</span></li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>样式和动画测试</h2>
        <ul>
            <li>玻璃态效果 <span class="status success">✓</span></li>
            <li>渐变色彩 <span class="status success">✓</span></li>
            <li>悬停动画 <span class="status success">✓</span></li>
            <li>响应式设计 <span class="status success">✓</span></li>
            <li>加载动画 <span class="status success">✓</span></li>
        </ul>
    </div>

    <div class="test-section">
        <h2>JavaScript功能测试</h2>
        <ul>
            <li>API服务集成 <span class="status success">✓</span></li>
            <li>搜索防抖 <span class="status success">✓</span></li>
            <li>筛选功能 <span class="status success">✓</span></li>
            <li>数据渲染 <span class="status success">✓</span></li>
            <li>错误处理 <span class="status success">✓</span></li>
        </ul>
    </div>

    <div class="test-section">
        <h2>测试说明</h2>
        <p>所有功能模块已完成开发，包括：</p>
        <ul>
            <li><strong>知识库页面</strong>：实现了搜索、分类筛选、数据加载等功能，支持模拟数据和API集成</li>
            <li><strong>开发地带页面</strong>：实现了项目展示、状态筛选、技术标签等功能</li>
            <li><strong>博客页面</strong>：实现了文章展示、分类筛选、搜索、模态框等功能</li>
            <li><strong>关于页面</strong>：添加了时间线、技能卡片动画、项目展示等增强功能</li>
        </ul>
        <p>所有页面都支持响应式设计，在不同设备上都能正常显示和操作。</p>
    </div>

    <!-- 加载API服务 -->
    <script>
        // 设置API URL - 本地开发环境
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            window.API_URL = 'http://localhost:5000/api';
        }
    </script>
    <script src="js/api-service.js"></script>
    
    <script>
        // 简单的功能测试
        console.log('TOGETHER 网站功能测试页面已加载');
        
        // 测试API服务
        if (typeof window.apiService !== 'undefined') {
            console.log('API服务已加载:', window.apiService.baseURL);
        } else {
            console.log('API服务未加载，将使用模拟数据');
        }
        
        // 测试页面加载时间
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`页面加载时间: ${loadTime.toFixed(2)}ms`);
        });
    </script>

    <script>
        (function(){
            'use strict';
            const btnRun = document.getElementById('run-tests');
            const btnDownload = document.getElementById('download-report');
            const logEl = document.getElementById('test-log');
            let report = null;

            function log(line){
                console.log(line);
                logEl.textContent += (logEl.textContent ? '\n' : '') + line;
            }

            function detectFeatures(){
                const hasIO = 'IntersectionObserver' in window;
                const hasRAF = 'requestAnimationFrame' in window;
                const hasBF = CSS && CSS.supports && (CSS.supports('backdrop-filter','blur(2px)') || CSS.supports('-webkit-backdrop-filter','blur(2px)'));
                const prefersReduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                const m480 = window.matchMedia('(max-width: 480px)').matches;
                const m768 = window.matchMedia('(max-width: 768px)').matches;
                const m1024 = window.matchMedia('(min-width: 769px) and (max-width: 1024px)').matches;
                const mUHD = window.matchMedia('(min-width: 1920px)').matches;
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                return {
                    intersectionObserver: hasIO,
                    requestAnimationFrame: hasRAF,
                    backdropFilter: hasBF,
                    prefersReducedMotion: prefersReduce,
                    responsive: { max480: m480, max768: m768, mid769_1024: m1024, min1920: mUHD },
                    network: connection ? {
                        effectiveType: connection.effectiveType || 'unknown',
                        downlink: connection.downlink || null,
                        saveData: !!connection.saveData
                    } : null
                };
            }

            async function inspectIndex(){
                try {
                    const res = await fetch('index.html', { cache:'no-store' });
                    const html = await res.text();
                    const checks = {
                        hasDnsPrefetch: /dns-prefetch/.test(html),
                        hasPreconnect: /preconnect/.test(html),
                        navDefer: /<script\s+defer[^>]*src=\"js\/nav\.js\"/i.test(html),
                        apiDefer: /<script\s+defer[^>]*src=\"js\/api-service\.js\"/i.test(html),
                        perfUtils: /performance-utils\.js/.test(html),
                        dynamicLoadBg: /bg-container\{display:none/.test(html) || /动态加载重型动画/.test(html),
                        hasNoScript: /<noscript>[\s\S]*bg-container\{display:none!important\}[\s\S]*<\/noscript>/i.test(html)
                    };
                    return checks;
                } catch(e){
                    return { error: e && e.message ? e.message : String(e) };
                }
            }

            function collectPerformance(){
                const timing = performance.timing || {};
                const navEntries = performance.getEntriesByType ? performance.getEntriesByType('navigation') : [];
                let ttfb = null, domContentLoaded = null, loadEvent = null;
                if (navEntries && navEntries[0]) {
                    const n = navEntries[0];
                    ttfb = n.responseStart - n.requestStart;
                    domContentLoaded = n.domContentLoadedEventEnd - n.startTime;
                    loadEvent = n.loadEventEnd - n.startTime;
                } else if (timing.responseStart) {
                    ttfb = timing.responseStart - timing.requestStart;
                    domContentLoaded = timing.domContentLoadedEventEnd - timing.navigationStart;
                    loadEvent = timing.loadEventEnd - timing.navigationStart;
                }
                return { ttfb, domContentLoaded, loadEvent };
            }

            async function runAllTests(){
                logEl.textContent = '';
                log('开始执行自动化测试...');
                const startedAt = new Date().toISOString();

                const features = detectFeatures();
                log(`特性检测: IO=${features.intersectionObserver}, RAF=${features.requestAnimationFrame}, BF=${features.backdropFilter}`);
                if (features.network) {
                    log(`网络: type=${features.network.effectiveType}, downlink=${features.network.downlink}, saveData=${features.network.saveData}`);
                }

                const perf = collectPerformance();
                if (perf.ttfb != null) log(`TTFB: ${Math.round(perf.ttfb)}ms`);
                if (perf.domContentLoaded != null) log(`DOM 完成: ${Math.round(perf.domContentLoaded)}ms`);
                if (perf.loadEvent != null) log(`Load 事件: ${Math.round(perf.loadEvent)}ms`);

                const indexChecks = await inspectIndex();
                if (!indexChecks.error){
                    log(`index.html 校验: dns-prefetch=${indexChecks.hasDnsPrefetch}, preconnect=${indexChecks.hasPreconnect}, defer(nav/api)=${indexChecks.navDefer && indexChecks.apiDefer}`);
                    log(`性能脚本与降级: perf-utils=${indexChecks.perfUtils}, 动态加载/降级=${indexChecks.dynamicLoadBg}, noscript=${indexChecks.hasNoScript}`);
                } else {
                    log(`index.html 获取失败: ${indexChecks.error}`);
                }

                // 页面可达性简单检查（同源下快速 HEAD 请求）
                const links = [
                    'index.html','pages/knowledge.html','pages/development.html','pages/blog.html','pages/about.html'
                ];
                const reachability = {};
                for (const url of links){
                    try {
                        const r = await fetch(url, { method:'HEAD', cache:'no-store' });
                        reachability[url] = r.ok;
                    } catch(e){
                        reachability[url] = false;
                    }
                }
                log('可达性: ' + JSON.stringify(reachability));

                report = {
                    project: 'TOGETHER',
                    startedAt,
                    finishedAt: new Date().toISOString(),
                    location: window.location.href,
                    features,
                    performance: perf,
                    indexChecks,
                    reachability
                };
                btnDownload.disabled = false;
                log('测试完成。可点击“下载测试报告(JSON)”。');
            }

            function downloadReport(){
                if (!report) return;
                const blob = new Blob([JSON.stringify(report, null, 2)], { type:'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'phase4-test-report.json';
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                a.remove();
            }

            btnRun && btnRun.addEventListener('click', runAllTests);
            btnDownload && btnDownload.addEventListener('click', downloadReport);
        })();
    </script>
</body>
</html>
